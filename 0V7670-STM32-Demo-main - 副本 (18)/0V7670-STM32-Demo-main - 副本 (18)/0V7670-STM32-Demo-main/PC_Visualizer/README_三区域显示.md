# OV7670三区域独立显示系统 - 使用说明

## 📋 系统概述

本系统支持**三类照片独立采集与显示**，每类照片在PC端有专属展示区域，同类别后续拍摄自动覆盖上一张照片。

---

## 🎯 照片类型定义

| 按键 | 照片类型 | 补光模式 | 显示位置 | 文件前缀 |
|------|----------|----------|----------|----------|
| **1** | No Light (不补光) | 关闭所有补光 | 左上区域 | No_Light |
| **2** | Visible (可见光) | PB3开启可见光LED | 右上区域 | Visible_Light |
| **3** | Infrared (红外光) | PB4开启红外LED | 左下区域 | Infrared_Light |

---

## 🖥️ PC端显示布局

```
┌─────────────────┬─────────────────┐
│                 │                 │
│  [1] No Light   │  [2] Visible    │
│   (左上区域)    │   (右上区域)    │
│   320×240       │   320×240       │
│                 │                 │
├─────────────────┼─────────────────┤
│  [3] Infrared   │   (空)          │
│   (左下区域)    │                 │
│   320×240       │                 │
│                 │                 │
└─────────────────┴─────────────────┘
总窗口尺寸: 680×520像素
彩色边框: 绿/黄/橙
```

---

## 🚀 使用流程

### 1. 烧录STM32代码
```bash
# 使用Keil MDK
# 1. 打开 project.uvprojx
# 2. 编译 (F7)
# 3. 烧录 (F8)
# 4. 按复位键
```

### 2. 运行PC程序
```bash
cd PC_Visualizer
python camera_viewer_fixed_display.py
```

### 3. 拍照操作
- **按下按键1**: 拍摄 [1] No Light → 显示在左上区域
- **按下按键2**: 拍摄 [2] Visible → 显示在右上区域
- **按下按键3**: 拍摄 [3] Infrared → 显示在左下区域

---

## 📸 功能特性

### ✅ 自动覆盖机制
```
第一次按1: 保存 No_Light_1.jpg → 显示在左上
第二次按1: 保存 No_Light_2.jpg → **覆盖**左上显示，保留最新
第三次按1: 保存 No_Light_3.jpg → 显示在左上（最新）
```
**注意**: 所有历史照片仍会保存，但PC端只显示最新一张

### ✅ 实时显示更新
- **刷新率**: 10Hz (每0.1秒更新)
- **无卡顿**: 显示与数据处理分离
- **即时反馈**: 拍照后立即显示

### ✅ 数据完整性
- **CRC32校验**: 确保数据无丢失
- **协议解析**: 状态机防止数据错位
- **错误重试**: CRC失败自动丢弃

---

## 🎨 界面说明

### PC端窗口
- **标题**: "OV7670 Camera - 三区域独立显示"
- **分割线**: 灰色线条分隔三个区域
- **边框**: 彩色边框强调各区域
- **标签**:
  - 绿色文字: "[1] No Light" (左上)
  - 黄色文字: "[2] Visible" (右上)
  - 橙色文字: "[3] Infrared" (左下)

### 控制按键
- **ESC**: 退出程序
- **S**: 手动保存所有当前显示的照片

---

## 📁 文件管理

### 自动保存路径
```
PC_Visualizer/
├── captures/
│   ├── 20260103_143025_No_Light_1.jpg
│   ├── 20260103_143030_Visible_Light_1.jpg
│   ├── 20260103_143035_Infrared_Light_1.jpg
│   ├── 20260103_143040_No_Light_2.jpg      # 覆盖模式
│   └── ...
```

### 文件命名规则
```
{时间戳}_{照片类型}_{序号}.jpg
示例: 20260103_143025_No_Light_1.jpg
```

---

## 🔧 协议格式更新

### STM32 → PC 协议
```
旧协议: IMG_START,320,240,16,1\r\n
新协议: IMG_START,320,240,16,{type},1\r\n
```

**参数说明**:
- `320`: 图像宽度
- `240`: 图像高度
- `16`: 位深 (RGB565)
- `{type}`: 照片类型 (1=不补光, 2=可见光, 3=红外光)
- `1`: CRC32使能

---

## 📊 数据流图

```
STM32按键触发
    ↓
设置补光模式
    ↓
等待FIFO数据就绪
    ↓
发送帧头: IMG_START,320,240,16,{type},1\r\n
    ↓
发送240行数据 (153,600字节)
    ↓
发送CRC32 (4字节)
    ↓
发送帧尾: IMAGE_END\r\n
    ↓
PC端状态机解析
    ↓
CRC校验
    ↓
RGB565 → BGR888转换
    ↓
更新对应显示区域
    ↓
自动保存到文件
```

---

## ⚡ 性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 分辨率 | 320×240 | QVGA |
| 波特率 | 921600 | 高速传输 |
| 传输时间 | 约1.7秒/帧 | 含CRC计算 |
| 显示刷新 | 10Hz | 无卡顿 |
| 数据校验 | CRC32 | 100%可靠 |
| 覆盖延迟 | <0.1秒 | 实时更新 |

---

## 🛠️ 故障排查

### 问题1: PC端无图像显示
**检查**:
1. 串口是否正确连接
2. 波特率是否为921600
3. STM32是否正常运行

### 问题2: 图像花屏/错位
**解决**:
1. 检查CRC校验是否通过
2. 确认数据包完整性
3. 降低波特率测试

### 问题3: 显示卡顿
**优化**:
1. 确保Numba已安装: `pip install numba`
2. 关闭其他占用CPU的程序
3. 检查串口缓冲区是否溢出

---

## 💡 使用技巧

1. **快速测试**: 连续按不同按键，观察三区域变化
2. **对比分析**: 同一场景拍摄三类照片，对比效果
3. **批量拍摄**: 按键1多次，观察自动覆盖效果
4. **手动保存**: 按S键保存当前所有三张照片

---

## 📝 更新日志

### v2.0 - 三区域独立显示版
- ✅ 新增照片类型标识
- ✅ 实现三区域独立显示
- ✅ 自动覆盖同类别照片
- ✅ 实时更新无卡顿
- ✅ 增强状态机解析
- ✅ 优化CRC校验流程

---

**系统已就绪，祝您使用愉快！** 🎉
